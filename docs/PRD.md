# PRD — 미디어 파일명 표준화 도구 (Python GUI)
> Version: v1.0 (2026-01-08)  
> Platform: Windows (PyInstaller 배포)  
> GUI: tkinter  
> Metadata Engine: ExifTool(번들 포함, 외부 실행)  

---

## 0. 프로젝트/저장소 정보

### 0.1 GitHub 저장소명
- `media-shotdate-renamer` 

---

## 1. 프로젝트 개요

### 1.1 목적
대량(수천 장 이상) 미디어 파일(사진/동영상)의 **촬영일(메타데이터)**, **카메라 정보**, **원본 파일명의 `IMG_<식별번호>` 패턴**을 활용하여 파일명을 표준화한다.  
원본은 변경하지 않으며, **조건을 만족하는 파일만** 결과 폴더에 복사 생성한다.

### 1.2 목표(Goals)
1) 파일 단위로 아래 항목을 확인한다.
- 촬영일 메타데이터 존재 여부
- 카메라(기기) 정보 추출 및 정규화
- 파일명 `IMG_<식별번호>` 패턴 여부
- 이미 표준 파일명(PASS 패턴)인지 여부

2) 조건을 만족하면 결과 폴더에 **표준 파일명**으로 복사 생성한다.
- 표준 파일명: `YYYY-MM-DD_HH-MM-SS_<식별번호>_<카메라>.<ext>`
- 예:
  - `2025-10-01_14-36-07_9672_EOSR7.jpg`
  - `2025-10-01_14-36-07_9321a_EOS200D2.cr3`
  - `2025-10-01_14-36-07_1234_iPhone.mov`
  - `2025-10-01_14-36-07_1563b_UNKNOWN.dng`

3) 결과는 **촬영일(YYYY-MM-DD) 기준** 폴더로 분리하여 저장한다.
- 결과 루트: `[SourceRoot]/result/`
- 결과 경로: `[SourceRoot]/result/YYYY-MM-DD/<결과 파일>`
  - 원본 폴더 구조는 유지하지 않는다(날짜 폴더 내 평탄화 저장).

4) 사용자 로그는 **한글**로 출력/저장한다.

---

## 2. 사용자 흐름(User Flow)

1) 프로그램 실행 → 소스 폴더 선택  
2) [변환 시작] 클릭  
3) 하위 폴더를 재귀적으로 탐색하며 대상 파일 수집  
4) 각 파일에 대해 처리 파이프라인 수행(§7)  
5) 완료 팝업 → “결과 폴더 열기” 버튼 활성화  

---

## 3. 범위(Scope)

### 3.1 In Scope
- GUI(폴더 선택/진행률/로그/결과 폴더 열기)
- 재귀 탐색(하위 폴더 포함), `[SourceRoot]/result/YYYY-MM-DD` 생성
- 원본 비파괴(원본은 변경하지 않고 결과 폴더에 복사 생성)
- 멀티스레딩/비동기 구조로 GUI 프리징 방지
- 파일 단위 예외 격리 및 `error.log` 기록
- 사용자 로그 한글 출력 및 파일 저장
- ExifTool 번들 포함(외부 실행)

### 3.2 Out of Scope
- 원본 파일 rename/overwrite
- 메타데이터 “쓰기/수정”(읽기만 수행)
- 트랜스코딩/압축/품질 변경
- 유사 사진 판별(해시/AI) 등 정리 기능

---

## 4. 기능 요구사항(Functional Requirements)

## FR-01 폴더 탐색 및 수집(Directory Traversal)
- 사용자는 GUI에서 소스 루트 폴더를 선택할 수 있어야 한다.
- 하위 폴더를 모든 깊이로 재귀 탐색해야 한다.
- 결과 폴더(`[SourceRoot]/result`)는 탐색에서 제외하여 자기 결과 재처리를 방지한다.
- 파일 목록은 **결정성을 위해 정렬**한다(예: 전체 경로 오름차순).

## FR-02 지원 형식(Supported Formats)
- 이미지: `.jpg`, `.jpeg`, `.png`, `.heic`, `.cr3`, `.dng`, `.gif`
- 동영상: `.mp4`, `.mov`
- 결과 확장자는 **소문자로 통일**한다(예: `.JPG` → `.jpg`).

## FR-03 메타데이터 추출(촬영일/카메라)
### FR-03-1 촬영일(찍은 날짜) 우선순위(확정)
- 이미지: `DateTimeOriginal` > `CreateDate` > `MediaCreateDate`
- 동영상: `MediaCreateDate` > `CreateDate` > `TrackCreateDate`
- 테스트 결과가 의도와 다를 경우, 태그 우선순위/예외 규칙을 조정한다.

### FR-03-2 시간대(Timezone) 처리(확정)
- 메타데이터에 offset 유무와 상관없이 **원문 그대로** 사용한다(변환/보정 없음).

### FR-03-3 촬영일이 없는 파일 처리(확정)
- 촬영일이 없으면 **결과에 저장하지 않고 스킵**한다.
- 사용자 로그에 (상위폴더명, 파일명, 사유)를 기록한다.

### FR-03-4 카메라 정규화(확정)
- 출력 카메라 토큰: `EOSR7`, `EOS200D2`, `iPhone`, `UNKNOWN`
- Canon EOS 200D II의 EXIF Model 표기가 환경마다 달라도 모두 `EOS200D2`로 묶는다.
- 카메라 정보가 없거나 매핑 불가 시 `UNKNOWN`으로 처리한다.
- **UNKNOWN 자체에 대한 로그는 남기지 않는다.**

## FR-04 파일명 패턴 판별
### FR-04-1 IMG 패턴(변환 후보)
- 파일명이 `IMG_<식별번호>` 패턴이어야 변환 후보가 된다.
- `<식별번호>` 허용 범위(확정): `영문 및 숫자의 조합 (1~15자)`
  - 대소문자 무시(IMG/img 허용)
- 권장 정규식:
  - `^IMG_(?P<id>[a-z0-9]{1,15})$` (Case-Insensitive)

### FR-04-2 PASS 패턴(이미 표준화)
- 파일명이 아래 형식이면 **PASS(수정하지 않음)** 하되, 결과 폴더로 복사 저장한다.
  - `YYYY-MM-DD_HH-MM-SS_<식별번호>_<카메라>.<ext>`
- PASS 파일도 메타데이터에서 촬영일을 읽어 `result/YYYY-MM-DD/`에 저장한다(확정).
- 권장 정규식(파일명 본문):
  - `^\d{4}-\d{2}-\d{2}_\d{2}-\d{2}-\d{2}_[^_]+_[A-Za-z0-9]+$`

## FR-05 변환/복사 정책(확정)
- **저장(복사) 대상**
  1) 변환 조건 만족: `촬영일 있음` AND `IMG 패턴` → 표준 파일명으로 복사 저장
  2) PASS 패턴: 이미 표준 파일명 → 이름 유지하여 복사 저장
- **스킵 대상(저장하지 않음 + 로그)**
  - 촬영일 없음 → 스킵 + 로그
  - IMG 패턴 아님 → 스킵 + 로그
  - 그 외 조건 미충족 → 스킵 + 로그

## FR-06 충돌/멱등성 처리
### FR-06-1 동일 실행(run) 내 충돌 처리(확정)
- 결과 파일명이 이미 존재할 경우, 식별번호 뒤에 숫자를 **언더바 없이** 바로 증가 부여
  - `..._9672_EOSR7` → `..._96721_EOSR7` → `..._96722_EOSR7` …
- 충돌 발생 시 사용자 로그에 기록한다(원래 결과명 → 최종 결과명).
- 비표준 파일명의 경우, 파일명 끝(확장자 앞)에 숫자를 붙여서 충돌을 해결한다 (`...stem1.ext`, `...stem2.ext`).

### FR-06-2 재실행 시(멱등성, 확정)
- 결과 파일이 이미 존재하면 **스킵**한다(중복 생성 방지).
- 스킵하기 전, 원본 파일과 대상 파일의 크기 및 수정 시간을 비교하여 동일한 파일인지 확인한다.

## FR-07 UI 및 피드백
- UI 구성:
  - 소스 폴더 선택(경로 표시)
  - 변환 시작 버튼
  - 진행률(ProgressBar + % + 처리/전체)
  - 로그창(실시간, 스크롤)
  - 완료 팝업 + “결과 폴더 열기” 버튼
- 멀티스레딩:
  - 작업 스레드(또는 워커)에서 처리, UI 스레드는 Queue로 이벤트 수신/렌더링
  - GUI 프리징 금지

## FR-08 로깅/리포트
### FR-08-1 사용자 로그(한글)
- 저장 위치(권장): `[SourceRoot]/result/run.log`
- 기록 대상(필수):
  - 시작/종료
  - 변환 성공(원본 → 결과)
  - PASS 복사(원본 → 결과)
  - 스킵(촬영일 없음): 상위폴더명/파일명
  - 스킵(IMG 패턴 아님): 상위폴더명/파일명
  - 충돌 처리(원래 → 최종)
  - 이미 존재하여 스킵(멱등성)
- 제외(확정):
  - 카메라 `UNKNOWN` 자체는 로그로 남기지 않음

### FR-08-2 error.log(예외 상세)
- 저장 위치(권장): `[SourceRoot]/result/error.log`
- 최소 포함:
  - 시간(ISO), 파일 전체 경로, 예외 메시지, 스택트레이스(가능하면)

### FR-08-3 처리 요약(종료 시)
- 총 파일 수
- 변환 성공 수 / PASS 복사 수
- 스킵(촬영일 없음) 수 / 스킵(IMG 아님) 수
- 충돌 처리 수
- 이미 존재하여 스킵 수
- 에러 수

---

## 5. 비기능적 요구사항(Non-Functional Requirements)

### NFR-01 성능/UX(필수)
- 수천 장 처리에서도 GUI 프리징이 없어야 한다.
- ExifTool 호출 오버헤드로 성능이 과도하게 저하되지 않도록 **배치 추출(Batch Extraction)** 방식을 적용한다.

### NFR-02 안정성(원본 보호)
- 원본 파일은 변경하지 않는다.
- 결과 폴더에 대한 쓰기 권한이 없으면 시작 전에 차단/안내한다.

### NFR-03 결정성/재현성
- 동일 입력에 대해 동일 규칙이 적용되도록 파일 목록 정렬 및 규칙 일관성을 유지한다.

---

## 6. ExifTool 성능 저하 예방(필수 설계 항목)

> 목표: “파일 1개당 exiftool 프로세스 1회 실행”을 피하고, 호출/파싱 비용을 최소화한다.

### 6.1 적용된 전략
- **배치 추출(Chunk)**
   - 500개 단위로 exiftool을 호출하여 JSON을 일괄 추출
   - 파이썬에서 매칭/규칙 적용 및 복사 수행

---

## 7. 처리 파이프라인(파일 1개 기준)

1) (수집 단계) 대상 파일 목록 수집 및 정렬  
2) (추출 단계) ExifTool로 촬영일/카메라/필요 태그 추출(배치)
3) (판별 단계)
   - PASS 패턴이면 → 촬영일 추출 성공 시 해당 날짜 폴더로 복사 저장
   - PASS가 아니면:
     - 촬영일 없으면 → 스킵 + 로그
     - IMG 패턴 아니면 → 스킵 + 로그
     - 촬영일 + IMG면 → 표준 파일명 생성(카메라 UNKNOWN 가능)
4) (저장 단계)
   - 결과 경로: `[SourceRoot]/result/YYYY-MM-DD/`
   - 확장자 소문자 통일
   - 충돌 규칙 적용
   - 결과 파일 존재 시 스킵(멱등성)
5) (피드백 단계) 진행률/로그 갱신  
6) (예외) 파일 단위 예외는 `error.log` 기록 후 다음 파일 계속  

---

## 8. 패키징/배포 요구사항(PyInstaller)

### 8.1 배포 형태
- Windows 실행 파일 배포(PyInstaller)
- ExifTool을 번들에 포함하여 별도 설치 없이 동작해야 한다.

### 8.2 .spec 파일 생성(필수)
- `.spec` 파일을 통해 아래 항목을 보장한다.
  - exiftool 실행 파일(예: `tools/exiftool.exe`)이 dist에 포함
  - 실행 시 코드에서 번들 내부 경로(또는 임시 풀린 경로)를 탐지하여 exiftool을 호출
  - 로그/결과 폴더는 `[SourceRoot]/result/`에 생성(프로그램 설치 경로가 아님)

> Note: `.spec` 파일은 구현 단계에서 생성/관리하며, PRD의 요구사항으로 고정한다.

---

## 9. 수용 기준(Acceptance Criteria)

- AC-01: 촬영일 + IMG 패턴 파일은 `result/YYYY-MM-DD/`에 표준 파일명으로 복사 저장된다.
- AC-02: PASS 패턴 파일은 이름 변경 없이 복사 저장되며, 촬영일 기준 날짜 폴더에 들어간다.
- AC-03: 촬영일 없는 파일은 저장되지 않고 한글 로그에 기록된다.
- AC-04: IMG 패턴이 아닌 파일은 저장되지 않고 한글 로그에 기록된다.
- AC-05: 충돌 발생 시 식별번호 뒤 숫자 증가 규칙으로 해결된다.
- AC-06: 재실행 시 결과 파일이 존재하면 스킵되어 중복 생성되지 않는다.
- AC-07: 일부 파일 오류가 있어도 전체 작업은 중단되지 않는다(error.log 기록).
- AC-08: 수천 장 처리 시 GUI 프리징이 발생하지 않는다(워크 스레드/Queue 기반).

---

## 10. 변경/리스크 관리(운영 메모)

- 메타데이터 태그 우선순위는 확정되어 있으나,
  파일별/포맷별로 기대와 다르게 해석될 수 있으므로 테스트 결과에 따라 조정한다.
- 결과가 날짜 폴더 내 평탄화 구조이므로 충돌이 빈번할 수 있다.
  충돌/멱등성 규칙(정렬 포함)은 반드시 유지한다.
- ExifTool 번들 포함은 포맷 커버리지 측면에서 안정적이지만, 성능 이슈는 배치 추출 전략으로 완화되었다.
